<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KDKMP TPP Sultra</title>
<link rel="icon" type="image/x-icon" href="word.png">

<!-- Bootstrap 5 CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- DataTables CSS -->
<link href="https://cdn.datatables.net/1.13.1/css/dataTables.bootstrap5.min.css" rel="stylesheet">
<!-- Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

<style>
:root {
  --primary-color: #8ccaf3;
  --secondary-color: #1e56f0;
  --accent-color: #e74c3c;
  --light-color: #f8f9fa;
  --dark-color: #2c3e50;
  --info-color: #3498db;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background-color: #f5f7f9;
  padding-bottom: 70px;
}

.app-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
  padding: 12px;
  border-radius: 12px;
  margin-bottom: 20px;
  box-shadow: 0 6px 12px rgba(0,0,0,0.2);
  position: relative;
  color: #fff;
}

.app-header::after {
  content: "";
  position: absolute;
  inset: 0;
  background: linear-gradient(to bottom, rgba(0,0,0,0.15), rgba(0,0,0,0.05));
  border-radius: 12px;
  pointer-events: none;
}

/* Logo */
.header-logos {
  display: flex;
  gap: 15px;
  align-items: center;
  justify-content: center;
  z-index: 1;
}

.header-logos .logo {
  height: 80px;
  width: auto;
  border-radius: 8px;
  opacity: 0.8;
  transition: opacity 0.3s ease;
}
.header-logos .logo:hover { opacity: 1; }

/* Teks */
.header-text {
  z-index: 1;
  text-align: left;
}
.header-text h1,
.header-text p {
  margin: 0;
  color: #fff;
  text-shadow: 2px 2px 6px rgba(0,0,0,0.5);
}

/* Responsive */
@media (max-width: 768px) {
  .header-logos { display: none; }
  .app-header {
    justify-content: center;
    text-align: center;
  }
  .header-text { text-align: center; }
  .header-text h1 { font-size: 1.5rem; }
  .header-text p  { font-size: 1rem; }
}

@media (max-width: 480px) {
  .app-header { padding: 15px; }
  .header-text h1 { font-size: 1.2rem; }
  .header-text p  { font-size: 0.9rem; }
}

.card {
  border-radius: 8px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.05);
  margin-bottom: 20px;
  border: none;
}

.card-header {
  background-color: white;
  border-bottom: 1px solid #eaeaea;
  font-weight: 600;
  padding: 15px 20px;
}

.btn-action {
  margin: 5px;
  border-radius: 6px;
  font-weight: 500;
}

/* Tabel */
#tblData {
  width: 100% !important;
  border-collapse: separate;
  border-spacing: 0;
}

thead {
  background: linear-gradient(135deg, #3498db, #2c3e50);
  color: white;
}

#tblData th {
  border-right: 1px solid rgba(255, 255, 255, 0.1);
  color: white;
  font-weight: 600;
  text-align: center;
  vertical-align: middle;
  padding: 12px 10px;
  position: sticky;
  top: 0;
}

#tblData td {
  padding: 10px;
  vertical-align: middle;
}

#tblData tbody tr {
  transition: background-color 0.2s;
}

#tblData tbody tr:hover {
  background-color: rgba(52, 152, 219, 0.1);
  cursor: pointer;
}

/* Highlight */
.row-highlight {
  animation: highlight 2s ease;
}

@keyframes highlight {
  0% { background-color: rgba(76, 175, 80, 0.3); }
  100% { background-color: transparent; }
}

/* Modal */
.modal-content {
  border-radius: 10px;
  border: none;
  box-shadow: 0 10px 30px rgba(0,0,0,0.15);
}

.modal-header {
  background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
  color: white;
  border-top-left-radius: 10px;
  border-top-right-radius: 10px;
  padding: 15px 20px;
}

.modal-body {
  padding: 20px;
}

.modal-footer {
  border-top: 1px solid #eaeaea;
  padding: 15px 20px;
}

.form-label {
  font-weight: 600;
  color: var(--secondary-color);
  margin-bottom: 5px;
}

.form-control, .form-select {
  border-radius: 6px;
  padding: 10px;
  border: 1px solid #ddd;
}

.form-control:focus, .form-select:focus {
  border-color: var(--primary-color);
  box-shadow: 0 0 0 0.25rem rgba(52, 152, 219, 0.25);
}

/* Spinner */
#spinnerOverlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(255,255,255,0.9);
  z-index: 10000;
  display: none;
  justify-content: center;
  align-items: center;
  pointer-events: auto;
}

.spinner {
  border: 5px solid #f3f3f3;
  border-top: 5px solid var(--primary-color);
  border-radius: 50%;
  width: 50px;
  height: 50px;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  100% { transform: rotate(360deg); }
}

/* Footer */
footer {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: var(--dark-color);
  color: white;
  padding: 12px 20px;
  font-size: 14px;
  z-index: 1000;
  box-shadow: 0 -2px 5px rgba(0,0,0,0.2);
}

footer a {
  color: white;
  transition: color 0.3s;
}

footer a:hover {
  color: var(--info-color);
  text-decoration: underline;
}

#activityInfo {
  font-weight: 500;
}

.text-info {
  color: var(--info-color) !important;
}

@media (max-width: 576px) {
  footer {
    flex-direction: column;
    text-align: center;
    gap: 8px;
  }
  .text-end {
    text-align: center !important;
  }
}

/* Responsive */
@media (max-width: 768px) {
  .app-container {
    padding: 10px;
  }
  
  .btn-action {
    width: 100%;
    margin: 5px 0;
  }
  
  .modal-body .col-md-6 {
    margin-bottom: 15px;
  }
}
</style>
</head>
<body>

<div class="app-container">
  <div class="app-header">
    <div class="header-text">
      <h1 class="h3 mb-0">WebApp TPP Kab. Konawe</h1>
      <p class="mb-0">Data Koperasi Merah Putih Desa / Kelurahan</p>
    </div>
    <div class="header-logos">
      <img src="LogoKemendesa.png" alt="Logo Kemendesa" class="logo">
      <img src="LogoKemenKop.png" alt="Logo KemenKop" class="logo">
      <img src="LogoKopindoBaru.png" alt="Logo Kopindo" class="logo">
      <img src="logoKDKMP1.png" alt="Logo KDKMP" class="logo">
    </div>
  </div>

  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span>KDKMP Prov. SulTra</span>
      <div class="btn-group">
        <button id="btnAdd" class="btn btn-primary btn-action">
          <i class="fas fa-plus me-1"></i> Tambah Data
        </button>
        <button id="btnSync" class="btn btn-success btn-action">
          <i class="fas fa-sync-alt me-1"></i> Sinkronisasi
        </button>
      </div>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table id="tblData" class="table table-hover table-striped">
          <thead id="tblHead"></thead>
          <tbody id="tblBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal Form -->
<div class="modal fade" id="dataModal" tabindex="-1" aria-labelledby="modalTitle" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">Form Data</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="modalFields" class="row"></div>
      </div>
      <div class="modal-footer">
        <button id="btnDelete" class="btn btn-danger" style="display: none;">
          <i class="fas fa-trash me-1"></i> Hapus
        </button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button id="btnSave" class="btn btn-primary">
          <i class="fas fa-save me-1"></i> Simpan
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Spinner -->
<div id="spinnerOverlay">
  <div class="spinner"></div>
</div>

<footer class="d-flex justify-content-between align-items-center">
  <div class="d-flex align-items-center">
    <i class="fas fa-info-circle me-2 text-info"></i>
    <span id="activityInfo">Memuat aplikasi...</span>
  </div>
  
  <div class="text-end">
    <small>
      <i class="fas fa-building me-1"></i> CRUD-API.App 
      <a href="https://karyamandiri.com" target="_blank" class="text-decoration-none text-white">&copy; 2025 AinCodeLab <b>Karya Mandiri</b></a><br>
      <i class="fas fa-user me-1"></i> Build by 
      <a href="https://ainularif.karyamandiri.com" target="_blank" class="text-decoration-none text-white">
        Ainul Arif
      </a> &mdash; <i class="fas fa-id-badge me-1"></i> PLD-TPP.740228<br>
      <i class="fas fa-envelope me-1"></i> 
      <a href="mailto:aynularyf@gmail.com" class="text-decoration-none text-white">aynularyf@gmail.com</a>
    </small>
  </div>
</footer>

<!-- JavaScript Libraries -->
<script src="https://code.jquery.com/jquery-3.6.3.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.1/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.1/js/dataTables.bootstrap5.min.js"></script>

<script>
/* ---------- Konfigurasi ---------- */
// Ganti dengan URL Web App Anda setelah deploy
const API_URL = "https://script.google.com/macros/s/AKfycbwMG2DZncPXNTEgbjUOjGBWW6A3bJCcPdr7Ar_8IHTUQlPkWcpBg2AASch5oDRRXfCP/exec"; // Ganti dengan URL Anda

const DB_NAME = "crudDB";
const STORE_NAME = "records";
let db, headerFields = [], lastRowFields = [], dropdownData = {}, editingId = null;
let dataTable;

/* ---------- Spinner & Activity ---------- */
function showSpinner(show = true) {
  const spinner = document.getElementById('spinnerOverlay');
  spinner.style.display = show ? 'flex' : 'none';
  document.body.style.pointerEvents = show ? 'none' : 'auto';
}

function setActivity(msg) {
  document.getElementById('activityInfo').textContent = msg;
  console.log(msg);
}

/* ---------- IndexedDB ---------- */
function initDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, 1);
    
    req.onupgradeneeded = function(e) {
      db = e.target.result;
      if (!db.objectStoreNames.contains(STORE_NAME)) {
        const store = db.createObjectStore(STORE_NAME, { keyPath: "id" });
        store.createIndex("status", "status", { unique: false });
      }
    };
    
    req.onsuccess = function(e) {
      db = e.target.result;
      resolve(db);
    };
    
    req.onerror = function(e) {
      console.error("IndexedDB error:", e.target.error);
      reject(e.target.error);
    };
  });
}

function getAllFromDB() {
  return new Promise((resolve, reject) => {
    const transaction = db.transaction([STORE_NAME], "readonly");
    const store = transaction.objectStore(STORE_NAME);
    const request = store.getAll();
    
    request.onsuccess = function() {
      resolve(request.result);
    };
    
    request.onerror = function() {
      reject(request.error);
    };
  });
}

function saveToDB(data) {
  return new Promise((resolve, reject) => {
    const transaction = db.transaction([STORE_NAME], "readwrite");
    const store = transaction.objectStore(STORE_NAME);
    const request = store.put(data);
    
    request.onsuccess = function() {
      resolve();
    };
    
    request.onerror = function() {
      reject(request.error);
    };
  });
}

function deleteFromDB(id) {
  return new Promise((resolve, reject) => {
    const transaction = db.transaction([STORE_NAME], "readwrite");
    const store = transaction.objectStore(STORE_NAME);
    const request = store.delete(id);
    
    request.onsuccess = function() {
      resolve();
    };
    
    request.onerror = function() {
      reject(request.error);
    };
  });
}

/* ---------- API Calls ---------- */
async function fetchData(action, payload = null, id = null) {
  const body = { action };
  if (payload) body.payload = payload;
  if (id) body.id = id;
  
  try {
    const response = await fetch(API_URL, {
      method: "POST",
      body: JSON.stringify(body)
    });
    
    const result = await response.json();
    return result;
  } catch (error) {
    console.error("API Error:", error);
    return { status: "error", message: "Gagal terhubung ke server" };
  }
}

/* ---------- Dropdown ---------- */
async function loadDropdown() {
  const result = await fetchData("dropdown");
  if (result.status === "success" && result.fields && result.records) {
    const headers = result.fields[0];
    result.records.forEach(record => {
      Object.keys(record).forEach(key => {
        if (record[key]) {
          dropdownData[key] = dropdownData[key] || new Set();
          dropdownData[key].add(record[key]);
        }
      });
    });
    
    // Convert Set to Array
    for (const key in dropdownData) {
      dropdownData[key] = Array.from(dropdownData[key]);
    }
  }
}

/* ---------- Header Table ---------- */
function buildMergedHeader(fields) {
  const thead = document.getElementById("tblHead");
  thead.innerHTML = "";
  
  // Create header rows
  fields.forEach((row, rowIndex) => {
    const tr = document.createElement("tr");
    
    row.forEach((cell, colIndex) => {
      if (cell) {
        const th = document.createElement("th");
        th.textContent = cell;
        
        // Calculate rowspan
        let rowspan = 1;
        for (let i = rowIndex + 1; i < fields.length; i++) {
          if (!fields[i][colIndex]) rowspan++;
          else break;
        }
        
        // Calculate colspan
        let colspan = 1;
        for (let i = colIndex + 1; i < row.length; i++) {
          if (!row[i]) colspan++;
          else break;
        }
        
        if (rowspan > 1) th.rowSpan = rowspan;
        if (colspan > 1) th.colSpan = colspan;
        
        tr.appendChild(th);
      }
    });
    
    thead.appendChild(tr);
  });
}

/* ---------- Render Table ---------- */
async function renderTable() {
  showSpinner(true);
  setActivity("Memuat data...");
  
  try {
    // Load data from API
    const result = await fetchData("read");
    
    if (result.status === "success" && result.fields && result.records) {
      headerFields = result.fields;
      lastRowFields = headerFields[headerFields.length - 1];
      
      // Clear and save to IndexedDB
      await initDB();
      
      // Save records to IndexedDB
      for (const record of result.records) {
        await saveToDB({ ...record, sync: true });
      }
      
      // Build table
      buildMergedHeader(headerFields);
      const tbody = document.getElementById("tblBody");
      tbody.innerHTML = "";
      
      // Get data from IndexedDB
      const localData = await getAllFromDB();
      
      localData.forEach(record => {
        const tr = document.createElement("tr");
        tr.setAttribute("data-id", record.id || record.ID);
        
        lastRowFields.forEach(field => {
          const td = document.createElement("td");
          td.textContent = record[field] || "";
          tr.appendChild(td);
        });
        
        tr.addEventListener("click", () => openModal(record.id || record.ID, record));
        tbody.appendChild(tr);
      });
      
      // Initialize DataTables
      if ($.fn.DataTable.isDataTable('#tblData')) {
        dataTable.destroy();
      }
      
      dataTable = $('#tblData').DataTable({
        pageLength: 10,
        lengthMenu: [[5, 10, 25, 50, -1], [5, 10, 25, 50, "Semua"]],
        language: {
          search: "Cari:",
          lengthMenu: "Tampilkan _MENU_ data",
          info: "Menampilkan _START_ sampai _END_ dari _TOTAL_ data",
          paginate: {
            first: "Pertama",
            last: "Terakhir",
            next: "Lanjut",
            previous: "Sebelum"
          }
        }
      });
    } else {
      throw new Error(result.message || "Gagal memuat data");
    }
  } catch (error) {
    console.error("Error:", error);
    alert("Gagal memuat data: " + error.message);
  } finally {
    showSpinner(false);
    setActivity("Aplikasi siap digunakan");
  }
}

/* ---------- Modal Functions ---------- */
function openModal(id = null, data = null) {
  editingId = id;
  document.getElementById("modalTitle").textContent = id ? "Edit Data" : "Tambah Data";
  document.getElementById("btnDelete").style.display = id ? "block" : "none";
  
  const fieldsContainer = document.getElementById("modalFields");
  fieldsContainer.innerHTML = "";
  
  lastRowFields.forEach((field, index) => {
    const fieldName = headerFields.map(row => row[index]).filter(Boolean).join(" / ");
    
    const colDiv = document.createElement("div");
    colDiv.className = "col-md-6 mb-3";
    
    const label = document.createElement("label");
    label.className = "form-label";
    label.textContent = fieldName;
    label.htmlFor = field;
    
    let input;
    const value = data ? (data[field] || "") : "";
    
    if (dropdownData[field]) {
      input = document.createElement("select");
      input.className = "form-select";
      input.id = field;
      
      const defaultOption = document.createElement("option");
      defaultOption.value = "";
      defaultOption.textContent = "-- Pilih --";
      input.appendChild(defaultOption);
      
      dropdownData[field].forEach(option => {
        const opt = document.createElement("option");
        opt.value = option;
        opt.textContent = option;
        if (value === option) opt.selected = true;
        input.appendChild(opt);
      });
    } else {
      input = document.createElement("input");
      input.type = "text";
      input.className = "form-control";
      input.id = field;
      input.value = value;
    }
    
    colDiv.appendChild(label);
    colDiv.appendChild(input);
    fieldsContainer.appendChild(colDiv);
  });
  
  const modal = new bootstrap.Modal(document.getElementById('dataModal'));
  modal.show();
}

async function saveData() {
  showSpinner(true);
  setActivity("Menyimpan data...");
  
  try {
    const formData = {};
    lastRowFields.forEach(field => {
      const element = document.getElementById(field);
      if (element) {
        formData[field] = element.value;
      }
    });
    
    let result;
    if (editingId) {
      result = await fetchData("update", formData, editingId);
    } else {
      result = await fetchData("create", formData);
    }
    
    if (result.status === "success") {
      // Save to IndexedDB
      const recordToSave = { ...formData, id: editingId || result.id, sync: false };
      await saveToDB(recordToSave);
      
      // Reload table
      await renderTable();
      
      // Close modal
      const modal = bootstrap.Modal.getInstance(document.getElementById('dataModal'));
      modal.hide();
      
      alert("Data berhasil disimpan!");
    } else {
      throw new Error(result.message || "Gagal menyimpan data");
    }
  } catch (error) {
    console.error("Error:", error);
    alert("Gagal menyimpan data: " + error.message);
  } finally {
    showSpinner(false);
  }
}

async function deleteData() {
  if (!confirm("Yakin ingin menghapus data ini?")) return;
  
  showSpinner(true);
  setActivity("Menghapus data...");
  
  try {
    const result = await fetchData("delete", null, editingId);
    
    if (result.status === "success") {
      // Delete from IndexedDB
      await deleteFromDB(editingId);
      
      // Reload table
      await renderTable();
      
      // Close modal
      const modal = bootstrap.Modal.getInstance(document.getElementById('dataModal'));
      modal.hide();
      
      alert("Data berhasil dihapus!");
    } else {
      throw new Error(result.message || "Gagal menghapus data");
    }
  } catch (error) {
    console.error("Error:", error);
    alert("Gagal menghapus data: " + error.message);
  } finally {
    showSpinner(false);
  }
}

async function syncData() {
  showSpinner(true);
  setActivity("Sinkronisasi data...");
  
  try {
    // Get unsynced data from IndexedDB
    const allData = await getAllFromDB();
    const unsyncedData = allData.filter(item => !item.sync);
    
    for (const data of unsyncedData) {
      let result;
      
      if (data.status === "delete") {
        result = await fetchData("delete", null, data.id);
      } else if (data.id && data.id.startsWith("ID")) {
        // New data
        const { id, sync, status, ...payload } = data;
        result = await fetchData("create", payload);
        if (result.status === "success") {
          // Update local ID with server ID
          await deleteFromDB(id);
          await saveToDB({ ...payload, id: result.id, sync: true });
        }
      } else {
        // Update existing data
        const { sync, status, ...payload } = data;
        result = await fetchData("update", payload, data.id);
        if (result.status === "success") {
          await saveToDB({ ...data, sync: true });
        }
      }
    }
    
    // Reload from server to get latest data
    await renderTable();
    alert("Sinkronisasi berhasil!");
  } catch (error) {
    console.error("Error:", error);
    alert("Gagal sinkronisasi: " + error.message);
  } finally {
    showSpinner(false);
  }
}

/* ---------- Initialize App ---------- */
document.addEventListener('DOMContentLoaded', async function() {
  // Event Listeners
  document.getElementById("btnAdd").addEventListener("click", () => openModal());
  document.getElementById("btnSave").addEventListener("click", saveData);
  document.getElementById("btnDelete").addEventListener("click", deleteData);
  document.getElementById("btnSync").addEventListener("click", syncData);
  
  // Initialize
  showSpinner(true);
  try {
    await initDB();
    await loadDropdown();
    await renderTable();
  } catch (error) {
    console.error("Initialization error:", error);
    alert("Gagal menginisialisasi aplikasi: " + error.message);
  } finally {
    showSpinner(false);
  }
});
</script>
</body>
</html>
